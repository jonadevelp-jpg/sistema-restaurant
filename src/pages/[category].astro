---
import PublicLayout from '../layouts/PublicLayout.astro';
import HalalInfo from '../components/HalalInfo';
import NavigationMenu from '../components/NavigationMenu';
import CategoryHero from '../components/CategoryHero';
import Footer from '../components/Footer.astro';
import MenuSectionSimplified from '../components/public/MenuSectionSimplified';
import { supabase } from '../lib/supabase';

const { category: categorySlug } = Astro.params;

// Verificar configuración
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL;
const isConfigured = !!(supabaseUrl && supabaseUrl !== 'https://placeholder.supabase.co');

let category: any = null;
let items: any[] = [];
let allCategories: any[] = [];
let heroImages: string[] = [];

if (isConfigured) {
  try {
    // Obtener la categoría por slug (incluyendo visual_type)
    const { data: cat, error: catError } = await supabase
      .from('categories')
      .select('id, name, slug, description, order_num, is_active, visual_type, image_url')
      .eq('slug', categorySlug)
      .eq('is_active', true)
      .single();

    if (catError || !cat) {
      return Astro.redirect('/');
    }

    category = cat;

    // Obtener items de esta categoría
    const { data: itemsData, error: itemsError } = await supabase
      .from('menu_items')
      .select('*')
      .eq('category_id', category.id)
      .eq('is_available', true)
      .order('order_num', { ascending: true });

    if (!itemsError && itemsData) {
      items = itemsData;
      
      // Obtener imágenes destacadas de esta categoría para el hero slider
      const itemsWithImages = itemsData
        .filter((item: any) => item.image_url)
        .sort((a: any, b: any) => {
          if (a.is_featured && !b.is_featured) return -1;
          if (!a.is_featured && b.is_featured) return 1;
          return 0;
        })
        .slice(0, 5)
        .map((item: any) => item.image_url);
      
      heroImages = itemsWithImages;
    }

    // Obtener todas las categorías para navegación
    const { data: cats, error: catsError } = await supabase
      .from('categories')
      .select('*')
      .eq('is_active', true)
      .order('order_num', { ascending: true });

    if (!catsError && cats) {
      allCategories = cats;
    }
  } catch (error: any) {
    console.error('Error cargando datos:', error?.message || error);
    return Astro.redirect('/');
  }
} else {
  return Astro.redirect('/');
}

// Funciones helper ya no necesarias - el componente MenuSectionSimplified las maneja
---

<PublicLayout title={`${category.name} - Completos & Churrascos`}>
  <NavigationMenu client:load categories={allCategories} currentSlug={categorySlug} />
  
  <div class="min-h-screen bg-warm-50 relative">
    
    <div class="relative z-10">
      <!-- Hero de la categoría con imagen -->
      <CategoryHero 
        client:load 
        categoryName={category.name}
        categorySlug={category.slug}
        categoryImage={category.image_url}
      />

      <!-- Menú simplificado con visual_type -->
      <div class="px-4 pb-12">
        <div class="max-w-6xl mx-auto">
          {items && items.length > 0 ? (
            <MenuSectionSimplified 
              client:load
              categoryId={category.id}
              categoryName={category.name}
              categoryVisualType={category.visual_type}
            />
          ) : (
            <div class="text-center py-16">
              <div class="border-2 border-tomato-300/50 rounded-xl p-8 bg-white/90 max-w-md mx-auto shadow-lg">
                <p class="text-tomato-600 text-xl mb-4 font-semibold">No hay items disponibles</p>
                <a href="/" class="text-tomato-500 hover:text-tomato-600 underline font-medium">Volver al inicio</a>
              </div>
            </div>
          )}
        </div>
      </div>

      <Footer />
    </div>
  </div>

  <HalalInfo client:load />
</PublicLayout>

<style>
  .menu-card {
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }
  
  .menu-card:nth-child(1) { animation-delay: 0.1s; }
  .menu-card:nth-child(2) { animation-delay: 0.15s; }
  .menu-card:nth-child(3) { animation-delay: 0.2s; }
  .menu-card:nth-child(4) { animation-delay: 0.25s; }
  .menu-card:nth-child(5) { animation-delay: 0.3s; }
  .menu-card:nth-child(6) { animation-delay: 0.35s; }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
